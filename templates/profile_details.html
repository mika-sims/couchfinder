{% extends "base.html" %}
{% load static %}
{% load friendshiptags %}
{% block content %}

<section class="container-fluid min-vh-100 d-flex flex-column justify-content-center align-items-center py-5 main-bg"
    id="user_profile">
    <div class="container pt-sm-3 pt-md-5">
        <div class="row">
            <div class="col-lg-4">
                <div class="col">
                    <div class="container bg-white py-3 px-5 border">
                        <div class="container-fluid card-body profile-card pt-2 d-flex flex-column align-items-center">
                            <div class="container d-flex flex-column justify-content-center align-items-center gap-1">
                                <p class="col-8 col-md-5 col-lg-8 bg-danger text-light text-center py-2 rounded">
                                    {{ profile.couch_status|title }}
                                </p>
                                <form method="post" enctype="multipart/form-data" id="updateProfileForm">
                                    {% csrf_token %} {% if profile.image %}
                                    <div
                                        class="form-group position-relative text-center profile-picture_update-page-container">
                                        <img src="{{ profile.image.url }}" alt="profile picture"
                                            class="profile-picture_update-page img-fluid mb-4" />
                                        {% if request.user == profile.user %}
                                        <input type="file" name="profile_picture" id="id_profile_picture"
                                            class="d-none" />
                                        <label for="id_profile_picture"
                                            class="btn btn-primary text-light col-10 position-absolute top-50 start-50 translate-middle update-img-btn opacity-0">
                                            <i class="bi bi-upload me-2"></i>
                                            Upload
                                        </label>
                                        {% endif %}
                                    </div>
                                    {% else %}
                                    <img src="https://res.cloudinary.com/couchfinder/image/upload/v1694623533/placeholder_ceudwk.svg"
                                        alt="profile picture" class="mb-4 col-12" />
                                    {% endif %}
                                </form>
                                <p class="my-1">
                                    {{ profile.user.first_name }} {{ profile.user.last_name }}
                                </p>
                                <p class="m-1 small">
                                    <i class="bi bi-geo-alt-fill me-2 text-danger"></i>
                                    {{ profile.get_location }}
                                </p>
                                <p class="m-0 small">
                                    Last Login: {{ profile.user.last_login|date:"F j, Y" }}
                                </p>
                            </div>
                        </div>
                        <div class="d-flex align-items-center justify-content-around">
                            {% if request.user != profile.user %}
                            {% if not friendship_requests and not friends %}
                            <form method="post"
                                action="{% url 'profiles:send-friendship-request' pk=profile.user.pk %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-primary btn-sm px-3 mt-3 text-light">
                                    <i class="bi bi-person-plus-fill me-2"></i>
                                    Add Friend
                                </button>
                            </form>
                            {% endif %}

                            {% if friendship_requests %}
                            {% for friendship_request in friendship_requests %}
                            {% if friendship_request.from_user.id == profile.user.id %}
                            <form method="post" action="{% url 'profiles:accept-friendship-request' profile.user.pk %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-primary btn-sm px-3 mt-3 text-light">
                                    <i class="bi bi-person-check-fill me-2"></i>
                                    Accept
                                </button>
                            </form>
                            <form method="post" action="{% url 'profiles:reject-friendship-request' profile.user.pk %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-outline-danger btn-sm px-3 mt-3">
                                    <i class="bi bi-person-x-fill me-2"></i>
                                    Reject
                                </button>
                            </form>
                            {% elif friendship_request.to_user.id == profile.user.id %}
                            <form method="post" action="{% url 'profiles:cancel-friendship-request' profile.user.pk %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-outline-danger btn-sm px-3 mt-3">
                                    <i class="bi bi-person-x-fill me-2"></i>
                                    Cancel Request
                                </button>
                            </form>
                            {% else %}
                            <form method="post"
                                action="{% url 'profiles:send-friendship-request' pk=profile.user.pk %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-primary btn-sm px-3 mt-3 text-light">
                                    <i class="bi bi-person-plus-fill me-2"></i>
                                    Add Friend
                                </button>
                            </form>
                            {% endif %}
                            {% endfor %}
                            {% endif %}
                            {% endif %}

                            {% if friends %}
                            {% for friend in friends %}
                            {% if profile.user.id != friend.id %}
                            <!-- Display whatsapp button -->
                            <a href="https://wa.me/"
                                class="btn btn-outline-primary btn-sm px-3 mt-3" target="_blank"  rel="noopener">
                                <i class="bi bi-whatsapp me-2"></i>
                                Chat
                            </a>
                            <form method="post" action="{% url 'profiles:remove-friend' pk=profile.user.pk %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-outline-danger btn-sm px-3 mt-3">
                                    <i class="bi bi-person-x-fill me-2"></i>
                                    Remove Friend
                                </button>
                            </form>
                            {% elif profile.user == friend %}
                            <form method="post"
                                action="{% url 'profiles:send-friendship-request' pk=profile.user.pk %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-primary btn-sm px-3 mt-3 text-light">
                                    <i class="bi bi-person-plus-fill me-2"></i>
                                    Add Friend
                                </button>
                            </form>
                            {% endif %}
                            {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-8">
                <div class="mt-5 mt-lg-0">
                    <div class="container shadow py-3 px-3 bg-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center justify-content-between">
                                <a class="text-decoration-none"
                                    href="{% url 'profiles:friends-list' profile.user.pk %}">
                                    <i class="bi bi-people-fill"></i>
                                    Friends
                                </a>
                                <a class="text-decoration-none" href="#reviews">
                                    Reviews
                                    <i class="bi bi-hand-thumbs-up-fill"></i>
                                </a>
                            </div>
                            <hr class="hr text-body-tertiary mx-auto">
                            <div class="tab-content pt-2">
                                <div class="tab-pane fade show active profile-overview" id="profile-overview">
                                    <div class="row">
                                        <p class="fw-bold text-muted small py-0 my-0">About Me:</p>
                                        <p class="text-secondary">{{ profile.bio }}</p>
                                        <hr class="hr text-body-tertiary mx-auto">
                                    </div>
                                    <div class="row">
                                        <p class="fw-bold text-muted small py-0 my-0">
                                            Member Since:
                                        </p>
                                        <p class="text-secondary">
                                            {{ profile.user.date_joined|date:"F j, Y" }}
                                        </p>
                                        <hr class="hr text-body-tertiary mx-auto" />
                                    </div>
                                    <div class="row">
                                        <p class="fw-bold text-muted small py-0 my-0">
                                            Occupation:
                                        </p>
                                        <p class="text-secondary">{{ profile.occupation|title }}</p>
                                        <hr class="hr text-body-tertiary mx-auto" />
                                    </div>
                                    <div class="row">
                                        <p class="fw-bold text-muted small py-0 my-0">City:</p>
                                        <p class="text-secondary">
                                            {{ profile.city.name|default:"Not specified" }}
                                        </p>
                                        <hr class="hr text-body-tertiary mx-auto" />
                                    </div>
                                    <div class="row">
                                        <p class="fw-bold text-muted small py-0 my-0">
                                            State/Region:
                                        </p>
                                        <p class="text-secondary">
                                            {{ profile.region.name|default:"Not specified" }}
                                        </p>
                                        <hr class="hr text-body-tertiary mx-auto" />
                                    </div>
                                    <div class="row">
                                        <p class="fw-bold text-muted small py-0 my-0">Country:</p>
                                        <p class="text-secondary">
                                            {{ profile.country.name|default:"Not specified" }}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {% if friends %}
                {% for friend in friends %}
                {% if friend != profile.user %}
                <div class="row mt-5" id="reviews">
                    <div class="col-12">
                        <div class="container shadow py-3 px-3 px-md-5 bg-white">
                            <p class="nav-link text-danger">User Reviews</p>
                            <hr />
                            <div class="container m-0 px-0">
                                <div class="p-3 review bg-light">
                                    <div class="d-flex align-items-start">
                                        <a class="text-decoration-none text-secondary" href="">
                                            <img class="rounded-circle shadow-1-strong me-3"
                                                src="https://res.cloudinary.com/couchfinder/image/upload/v1694623533/placeholder_ceudwk.svg"
                                                alt="avatar" width="50" height="50" />
                                        </a>
                                        <div class="d-flex flex-column align-items-center justify-content-center">
                                            <a class="text-secondary mb-1 ms-0" href="">Test User</a>
                                        </div>
                                    </div>
                                    <p class="my-0">
                                        Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed
                                        do eiusmod tempor incididunt ut labore et dolore magna
                                        aliqua. Ut enim ad minim veniam, quis nostrud exercitation
                                        ullamco laboris nisi ut aliquip consequat.
                                    </p>
                                </div>
                                <div class="small d-flex justify-content-between mt-2">
                                    <a href="#!" class="d-flex align-items-center text-decoration-none ms-1">
                                        <i class="bi bi-heart me-3 text-danger small"></i>
                                        <p class="m-0 me-0 small">21 Likes</p>
                                    </a>
                                    <p class="d-flex flex-column align-items-start text-danger small m-0">
                                        January 12, 2020
                                    </p>
                                </div>
                                <hr />
                            </div>
                            <div class="card-footer py-3 border-0">
                                <div class="d-flex w-100">
                                    <div class="form-outline w-100">
                                        <textarea class="form-control" id="textAreaExample" rows="3"
                                            placeholder="Leave a comment"></textarea>
                                        <label class="form-label" for="textAreaExample" aria-label="message"></label>
                                    </div>
                                </div>
                                <div class="mt-2 pt-1 ms-0 d-flex justify-content-end">
                                    <button type="button" class="btn btn-primary btn-sm px-3 text-light me-2">
                                        Post
                                    </button>
                                    <button type="button" class="btn btn-outline-danger btn-sm px-3">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>
</section>
<script type="text/javascript">
    function pictureOverlay() {
        let updateImgBtn = document.querySelector(".update-img-btn");
        let profileImgContainer = document.querySelector(
            ".profile-picture_update-page-container"
        );
        let profilePicture = document.querySelector(".profile-picture_update-page");
        let imageUploadInput = document.querySelector("#id_profile_picture");

        profileImgContainer.addEventListener("mouseenter", function () {
            updateImgBtn.classList.remove("opacity-0");
            updateImgBtn.classList.add("opacity-100");
            updateImgBtn.style.transition = "opacity 0.3s, visibility 0s 0.3s";
            profilePicture.style.opacity = "0.5";
            profilePicture.style.transition = "opacity 0.3s";
        });

        profileImgContainer.addEventListener("mouseleave", function () {
            updateImgBtn.classList.remove("opacity-100");
            updateImgBtn.classList.add("opacity-0");
            updateImgBtn.style.transition = "opacity 0.3s, visibility 0s";
            profilePicture.style.opacity = "1";
            profilePicture.style.transition = "opacity 0.3s, visibility 0s";
        });

        // Handle image upload using AJAX
        imageUploadInput.addEventListener("change", function () {
            const formData = new FormData();
            formData.append("profile_picture", imageUploadInput.files[0]);

            fetch("{% url 'profiles:upload_image' %}", {
                method: "POST",
                body: formData,
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                },
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.image_url) {
                        // Update the image source
                        profilePicture.src = data.image_url;
                    } else {
                        console.error("Image upload failed:", data.error);
                    }
                })
                .catch((error) => {
                    console.error("Image upload error:", error);
                });
        });
    }
    window.addEventListener("DOMContentLoaded", pictureOverlay);
</script>

{% endblock content %}