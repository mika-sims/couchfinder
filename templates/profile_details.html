{% extends "base.html" %}
{% load static %}

{% block content %}

<section class="container-fluid min-vh-100 d-flex flex-column justify-content-center align-items-center py-5 main-bg"
    id="user_profile">
    <div class="container pt-sm-3 pt-md-5">
        <div class="row">
            <div class="col-lg-4">
                <div class="col">
                    <div class="container bg-white py-3 px-5 border">
                        <div class="container-fluid card-body profile-card pt-2 d-flex flex-column align-items-center">
                            <div class="container d-flex flex-column justify-content-center align-items-center gap-1">
                                <p class="col-6 col-sm-5 col-md-6 bg-danger text-light text-center py-2 rounded">
                                    {{ profile.couch_status|title }}
                                </p>
                                <form method="post" enctype="multipart/form-data" id="updateProfileForm">
                                    {% csrf_token %}
                                    {% if profile.image %}
                                    <div
                                        class="form-group position-relative text-center profile-picture_update-page-container">
                                        <img src="{{ profile.image.url }}" alt="profile picture"
                                            class="profile-picture_update-page img-fluid mb-4">
                                        <input type="file" name="profile_picture" id="id_profile_picture"
                                            class="d-none">
                                        <label for="id_profile_picture"
                                            class="btn btn-primary text-light position-absolute top-50 start-50 translate-middle update-img-btn opacity-0">
                                            <i class="bi bi-upload me-2"></i>
                                            Upload
                                        </label>
                                    </div>
                                    {% else %}
                                    <img src="https://res.cloudinary.com/couchfinder/image/upload/v1694623533/placeholder_ceudwk.svg"
                                        alt="profile picture" class="mb-4 col-12">
                                    {% endif %}
                                </form>
                                <p class="my-1">
                                    {{ profile.user.first_name }} {{ profile.user.last_name }}
                                </p>
                                <p class="m-1">
                                    <i class="bi bi-geo-alt-fill me-2"></i>
                                    {% if profile.city and profile.region and profile.country %}
                                    {{ profile.city }}, {{ profile.region}}, {{ profile.country }}
                                    {% else %}
                                    Not Specified
                                    {% endif %}
                                </p>
                                <p class="m-0 small">Last Login: {{ profile.user.last_login|date:"F j, Y" }}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 d-flex flex-wrap align-items-center justify-content-between mt-2">
                        <a class="text-decoration-none btn btn-primary text-light me-3" href="">Couch Request</a>
                        <a class="text-decoration-none btn btn-outline-secondary" href="#reviews">Reviews</a>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="mt-5 mt-lg-0">
                    <div class="container shadow py-3 px-3 bg-white">
                        <div class="card-body position-relative">
                            <!-- Start Settings Navbar -->
                            {% if user == profile.user %}
                            <!-- Hide from other users -->
                            <div class="dropdown position-absolute end-0">
                                <i class="bi bi-three-dots-vertical bg-light border border-danger rounded-circle d-flex align-items-center justify-content-center p-2"
                                    data-bs-toggle="dropdown"></i>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="{% url 'profiles:profile-update' user.pk %}"><i
                                                class="bi bi-pencil-square h6 nav-icon_user-detail-page me-3 text-danger"></i>
                                            Edit Profile</a></li>
                                    <li><a class="dropdown-item" href="{% url 'account_change_password' %}"><i
                                                class="bi bi-key h6 nav-icon_user-detail-page me-3 text-danger"></i>
                                            Change
                                            Password</a></li>
                                    <li><a class="dropdown-item" href="#"><i
                                                class="bi bi-trash h6 nav-icon_user-detail-page me-3 text-danger"></i>
                                            Delete
                                            Account</a></li>
                                </ul>
                            </div>
                            {% endif %}
                            <!-- End Settings Navbar  -->
                            <div class="tab-content pt-2">
                                <div class="tab-pane fade show active profile-overview pt-2 mt-4" id="profile-overview">
                                    <div class="row">
                                        <p class="fw-bold text-muted small py-0 my-0">About Me:</p>
                                        <p class="text-secondary">{{ profile.bio }}</p>
                                        <hr class="hr text-body-tertiary mx-auto">
                                    </div>
                                    <div class="row">
                                        <p class="fw-bold text-muted small py-0 my-0">Member Since:</p>
                                        <p class="text-secondary">{{ profile.user.date_joined|date:"F j, Y" }}</p>
                                        <hr class="hr text-body-tertiary mx-auto">
                                    </div>
                                    <div class="row">
                                        <p class="fw-bold text-muted small py-0 my-0">Occupation:</p>
                                        <p class="text-secondary">{{ profile.occupation|title }}</p>
                                        <hr class="hr text-body-tertiary mx-auto">
                                    </div>
                                    <div class="row">
                                        <p class="fw-bold text-muted small py-0 my-0">City:</p>
                                        <p class="text-secondary">{{ profile.city.name|default:"Not specified" }}</p>
                                        <hr class="hr text-body-tertiary mx-auto">
                                    </div>
                                    <div class="row">
                                        <p class="fw-bold text-muted small py-0 my-0">State/Region:</p>
                                        <p class="text-secondary">{{ profile.region.name|default:"Not specified" }}</p>
                                        <hr class="hr text-body-tertiary mx-auto">
                                    </div>
                                    <div class="row">
                                        <p class="fw-bold text-muted small py-0 my-0">Country:</p>
                                        <p class="text-secondary">{{ profile.country.name|default:"Not specified" }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-5" id="reviews">
                    <div class="col-12">
                        <div class="container shadow py-3 px-3 px-md-5 bg-white">
                            <p class="nav-link text-danger">User Reviews</p>
                            <hr>
                            <div class="container m-0 px-0">
                                <div class="p-3 review bg-light">
                                    <div class="d-flex align-items-start">
                                        <a class="text-decoration-none text-secondary" href="">
                                            <img class="rounded-circle shadow-1-strong me-3" src="" alt="avatar"
                                                width="50" height="50">
                                        </a>
                                        <div class="d-flex flex-column align-items-center justify-content-center">
                                            <a class="text-secondary mb-1 ms-0" href="">User</a>
                                        </div>
                                    </div>
                                    <p class="my-0">
                                        Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod
                                        tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam,
                                        quis nostrud exercitation ullamco laboris nisi ut aliquip consequat.
                                    </p>
                                </div>
                                <div class="small d-flex justify-content-between mt-2">
                                    <a href="#!" class="d-flex align-items-center text-decoration-none ms-1">
                                        <i class="bi bi-heart me-3 text-danger small"></i>
                                        <p class="m-0 me-0 small">21 Likes</p>
                                    </a>
                                    <p class="d-flex flex-column align-items-start text-danger small m-0">
                                        January 12, 2020
                                    </p>
                                </div>
                                <hr>
                            </div>
                            <div class="card-footer py-3 border-0">
                                <div class="d-flex w-100">
                                    <div class="form-outline w-100">
                                        <textarea class="form-control" id="textAreaExample" rows="3"
                                            placeholder="Leave a comment"></textarea>
                                        <label class="form-label" for="textAreaExample" aria-label="message"></label>
                                    </div>
                                </div>
                                <div class="mt-2 pt-1 ms-0 d-flex justify-content-end">
                                    <button type="button"
                                        class="btn btn-primary btn-sm px-3 text-light me-2">Post</button>
                                    <button type="button" class="btn btn-outline-danger btn-sm px-3">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<script type="text/javascript">
    function pictureOverlay() {
        let updateImgBtn = document.querySelector(".update-img-btn");
        let profileImgContainer = document.querySelector(".profile-picture_update-page-container");
        let profilePicture = document.querySelector(".profile-picture_update-page");
        let imageUploadInput = document.querySelector("#id_profile_picture");

        profileImgContainer.addEventListener("mouseenter", function () {
            updateImgBtn.classList.remove("opacity-0");
            updateImgBtn.classList.add("opacity-100");
            updateImgBtn.style.transition = "opacity 0.3s, visibility 0s 0.3s";
            profilePicture.style.opacity = "0.5";
            profilePicture.style.transition = "opacity 0.3s";
        });

        profileImgContainer.addEventListener("mouseleave", function () {
            updateImgBtn.classList.remove("opacity-100");
            updateImgBtn.classList.add("opacity-0");
            updateImgBtn.style.transition = "opacity 0.3s, visibility 0s";
            profilePicture.style.opacity = "1";
            profilePicture.style.transition = "opacity 0.3s, visibility 0s";
        });

        // Handle image upload using AJAX
        imageUploadInput.addEventListener("change", function () {
            const formData = new FormData();
            formData.append('profile_picture', imageUploadInput.files[0]);

            fetch("{% url 'profiles:upload_image' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': "{{ csrf_token }}",
                },
            })
                .then(response => response.json())
                .then(data => {
                    if (data.image_url) {
                        // Update the image source
                        profilePicture.src = data.image_url;
                    } else {
                        console.error("Image upload failed:", data.error);
                    }
                })
                .catch(error => {
                    console.error("Image upload error:", error);
                });
        });
    }
    window.addEventListener("DOMContentLoaded", pictureOverlay);
</script>

{% endblock content %}